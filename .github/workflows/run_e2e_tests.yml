name: Run E2E Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1,3"

jobs:
  e2e-test:
    runs-on: macos-26
    timeout-minutes: 30
    env:
      DEVELOPER_DIR: /Applications/Xcode_26.2.0.app/Contents/Developer
      FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60
      FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 6
      MAESTRO_DEVICE_ID: "iPhone 17 Pro"
    steps:
      - uses: actions/checkout@v6.0.2

      - name: Cache SPM packages
        uses: actions/cache@v5
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            .build
          key: spm-${{ runner.os }}-e2e-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-

      - name: Cache DerivedData
        uses: actions/cache@v5
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: deriveddata-${{ runner.os }}-e2e-${{ hashFiles('**/*.swift', '**/Package.resolved') }}
          restore-keys: |
            deriveddata-${{ runner.os }}-

      - name: Cache tools
        uses: actions/cache@v5
        with:
          path: tools
          key: tools-${{ runner.os }}-e2e-${{ hashFiles('scripts/tool/*.sh') }}

      - name: Install Maestro
        run: |
          brew tap mobile-dev-inc/tap
          brew install maestro

      - name: Build App
        run: make create-simulator-app

      - name: Boot Simulator
        run: |
          xcrun simctl boot "${MAESTRO_DEVICE_ID}" || true
          xcrun simctl privacy "${MAESTRO_DEVICE_ID}" grant all com.bivre.bookshelf.develop

      - name: Run E2E Tests
        run: maestro test --timeout 300000 .maestro

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: maestro-test-results
          path: .maestro/screenshots/
